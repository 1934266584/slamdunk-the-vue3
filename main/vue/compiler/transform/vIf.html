<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Vue3.0 源码解读</title>
    <meta name="generator" content="VuePress 1.4.1">
    <link rel="icon" href="/slamdunk-the-vue3/onepunch.jpeg">
    <script src="https://hm.baidu.com/hm.js?4484bd6412288feacc311fd7f2054116"></script>
    <meta name="description" content="Vue3.0 源码解读">
    <link rel="preload" href="/slamdunk-the-vue3/assets/css/0.styles.8a77ab8b.css" as="style"><link rel="preload" href="/slamdunk-the-vue3/assets/js/app.19f0a9f3.js" as="script"><link rel="preload" href="/slamdunk-the-vue3/assets/js/2.43eface2.js" as="script"><link rel="preload" href="/slamdunk-the-vue3/assets/js/14.a192b497.js" as="script"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/10.ce270f70.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/11.1a015dc8.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/12.3286883d.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/13.64717b64.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/15.77afe700.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/16.e3742f57.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/17.1e6994cd.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/18.aa67dea2.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/19.6aa0a648.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/20.3f65b4d6.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/21.1c13a471.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/22.931f90d4.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/23.175af59a.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/24.f8507621.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/3.350504d2.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/4.ce76527a.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/5.8846d71d.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/6.04c70b96.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/7.171c11ae.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/8.40d7a914.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/9.a7a94907.js">
    <link rel="stylesheet" href="/slamdunk-the-vue3/assets/css/0.styles.8a77ab8b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/slamdunk-the-vue3/" class="home-link router-link-active"><!----> <span class="site-name">Vue3.0 源码解读</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/slamdunk-the-vue3/main/" class="nav-link router-link-active">
  Vue 3.0 解读
</a></div><div class="nav-item"><a href="/slamdunk-the-vue3/about.html" class="nav-link">
  关于我
</a></div><div class="nav-item"><a href="https://github.com/hkc452/slamdunk-the-vue3" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/slamdunk-the-vue3/main/" class="nav-link router-link-active">
  Vue 3.0 解读
</a></div><div class="nav-item"><a href="/slamdunk-the-vue3/about.html" class="nav-link">
  关于我
</a></div><div class="nav-item"><a href="https://github.com/hkc452/slamdunk-the-vue3" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>响应式系统</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/slamdunk-the-vue3/main/vue/reactivity/effect.html" class="sidebar-link">effect</a></li><li><a href="/slamdunk-the-vue3/main/vue/reactivity/reactive.html" class="sidebar-link">reactive</a></li><li><a href="/slamdunk-the-vue3/main/vue/reactivity/baseHandlers.html" class="sidebar-link">baseHandlers</a></li><li><a href="/slamdunk-the-vue3/main/vue/reactivity/collectionHandlers.html" class="sidebar-link">collectionHandlers</a></li><li><a href="/slamdunk-the-vue3/main/vue/reactivity/ref.html" class="sidebar-link">ref</a></li><li><a href="/slamdunk-the-vue3/main/vue/reactivity/computed.html" class="sidebar-link">computed</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>编译模块</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/slamdunk-the-vue3/main/vue/compiler/compiler.html" class="sidebar-link">compiler</a></li><li><a href="/slamdunk-the-vue3/main/vue/compiler/parse.html" class="sidebar-link">parse</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>transform(正在施工🚧)</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/slamdunk-the-vue3/main/vue/compiler/transform.html" class="sidebar-link">transform</a></li><li><a href="/slamdunk-the-vue3/main/vue/compiler/transform/vOnce.html" class="sidebar-link">vOnce</a></li><li><a href="/slamdunk-the-vue3/main/vue/compiler/transform/vIf.html" class="active sidebar-link">vIf</a></li></ul></section></li><li><a href="/slamdunk-the-vue3/main/vue/compiler/codegen.html" class="sidebar-link">codegen</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>nodeTransforms 第二个就是 vIf, 不过在解析 vIf 之前，先来看看 createStructuralDirectiveTransform。</p> <p>注意  v-if 和 v-for 都属于 NodeTransform。</p> <blockquote><p>A structural directive transform is a technically a NodeTransform; Only v-if and v-for fall into this category.</p></blockquote> <p>从上面我们知道，只有 v-if 和 v-for 属于 结构化的指令变化 structural directive transform ，所以下面 createStructuralDirectiveTransform 这个方法也是明显只属于 这两个指令调用的。</p> <p>现在看看 createStructuralDirectiveTransform， 传参 name 和 回调 fn，name 会转化成 matches 方法用于匹配指令，如果 name 是字符串则判断全等，否则正则校验。接着返回 NodeTransform 函数，毕竟 createStructuralDirectiveTransform 属于 NodeTransform 工厂。在 NodeTransform 函数里面，我们先判断传入的节点类型是不是 NodeTypes.ELEMENT，接着判断 tagType 如果是  ElementTypes.TEMPLAT 且 上面有 v-slot 指令，也不进行处理。还记得什么时候 tagType 为 TEMPLATE 吗？ 就是 tag 为template ，且上面有 <code>if,else,else-if,for,slot</code> 指令时，这里不处理 v-slot 是因为它会被单独处理。接着我们循环节点上面的 prop 来寻找符合要求的指令，如果符合，我们从 prop 上面移除，同时在移除之后我们才调用 fn，就是为了避免递归死循环，最后保存 onExit 方法 return 出去。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createStructuralDirectiveTransform</span><span class="token punctuation">(</span>
  <span class="token parameter">name<span class="token operator">:</span> string <span class="token operator">|</span> RegExp<span class="token punctuation">,</span>
  fn<span class="token operator">:</span> StructuralDirectiveTransform</span>
<span class="token punctuation">)</span><span class="token operator">:</span> NodeTransform <span class="token punctuation">{</span>
  <span class="token keyword">const</span> matches <span class="token operator">=</span> <span class="token function">isString</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
    <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token parameter">n<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> n <span class="token operator">===</span> <span class="token function-variable function">name</span>
    <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">n<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> name<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">ELEMENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> props <span class="token punctuation">}</span> <span class="token operator">=</span> node
      <span class="token comment">// structural directive transforms are not concerned with slots</span>
      <span class="token comment">// as they are handled separately in vSlot.ts</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>tagType <span class="token operator">===</span> ElementTypes<span class="token punctuation">.</span><span class="token constant">TEMPLATE</span> <span class="token operator">&amp;&amp;</span> props<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span>isVSlot<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">const</span> exitFns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> props<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> prop <span class="token operator">=</span> props<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>prop<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">DIRECTIVE</span> <span class="token operator">&amp;&amp;</span> <span class="token function">matches</span><span class="token punctuation">(</span>prop<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// structural directives are removed to avoid infinite recursion</span>
          <span class="token comment">// also we remove them *before* applying so that it can further</span>
          <span class="token comment">// traverse itself in case it moves the node around</span>
          props<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
          i<span class="token operator">--</span>
          <span class="token keyword">const</span> onExit <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> prop<span class="token punctuation">,</span> context<span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>onExit<span class="token punctuation">)</span> exitFns<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>onExit<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> exitFns
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>下面我们正式看看怎么处理 vIf 指令的。<code>/^(if|else|else-if)$/</code> 就是用来匹配 v-if 指令的，接着调用 processIf 去处理，其中 processIf 基本继承传入的参数，除了多了一个回调函数之外，这个回调函数我们迟点讲解。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> transformIf <span class="token operator">=</span> <span class="token function">createStructuralDirectiveTransform</span><span class="token punctuation">(</span>
  <span class="token regex">/^(if|else|else-if)$/</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> dir<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">processIf</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> dir<span class="token punctuation">,</span> context<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ifNode<span class="token punctuation">,</span> branch<span class="token punctuation">,</span> isRoot</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>processIf 首先看看 v-if 指令的表达式是不是为空，除了 v-else 以外都不能为空，如果表达式为空，创建表达式为 true 的 SimpleExpression，同时会上报 <code>X_V_IF_NO_EXPRESSION</code> 错误。</p> <p>接着对于非浏览器环境，同时指定了前缀，而指令的表达式又不为空的，会调用 processExpression 解析表达式，这块不对 processExpression 展开讲，会在 transformExpression 一并讲解，之所以 vIf 要手动调用，是因为 vIf 在 transformExpression 的前面调用。需要注意的是，transformExpression 永远只在非浏览器下运行，因为它依赖 babel 去解析 JS AST。</p> <p>正常情况下，我们都是先声明 name 为 if 的 vIf 指令，所以我们进去 <code>dir.name === 'if'</code> 的分支。首先会调用 createIfBranch 创建分支 branch，然后新建 type 为 NodeTypes.IF 的 AST 节点，把我们新建的分支塞进去，同时调用 <code>context.replaceNode</code> 去替换当前的节点，我把 replaceNode 代码复制过来了，就是通过 parent、childIndex 替换当前节点，同时把 currentNode 赋值为新的节点，这里我们是替换了 ifNode 节点，这也是为什么在 transform 的时候 每次 nodeTransfs 循环后都要重新通过 currentNode 去取值。最后调用 processCodegen 去处理，processCodegen 就是我们调用 processIf 时传进来的回调函数，注意对于 exp 为 if 来说，回调最后一位 为 true，代表是 vif 指令的开头。</p> <p>我们先粗略说下 createIfBranch，就是为每个 v-if 创建 branch，type 为 IF_BRANCH，condition 为 v-if 的 exp，其中对于 children，如果 tagType 为 TEMPLATE 的，取它的 children，否则取自身。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// target-agnostic transform used for both Client and SSR</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">processIf</span><span class="token punctuation">(</span>
  node<span class="token operator">:</span> ElementNode<span class="token punctuation">,</span>
  dir<span class="token operator">:</span> DirectiveNode<span class="token punctuation">,</span>
  context<span class="token operator">:</span> TransformContext<span class="token punctuation">,</span>
  processCodegen<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>
    <span class="token parameter">node<span class="token operator">:</span> IfNode<span class="token punctuation">,</span>
    branch<span class="token operator">:</span> IfBranchNode<span class="token punctuation">,</span>
    isRoot<span class="token operator">:</span> boolean</span>
  <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token keyword">undefined</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    dir<span class="token punctuation">.</span>name <span class="token operator">!==</span> <span class="token string">'else'</span> <span class="token operator">&amp;&amp;</span>
    <span class="token punctuation">(</span><span class="token operator">!</span>dir<span class="token punctuation">.</span>exp <span class="token operator">||</span> <span class="token operator">!</span><span class="token punctuation">(</span>dir<span class="token punctuation">.</span>exp <span class="token keyword">as</span> SimpleExpressionNode<span class="token punctuation">)</span><span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> loc <span class="token operator">=</span> dir<span class="token punctuation">.</span>exp <span class="token operator">?</span> dir<span class="token punctuation">.</span>exp<span class="token punctuation">.</span>loc <span class="token operator">:</span> node<span class="token punctuation">.</span>loc
    context<span class="token punctuation">.</span><span class="token function">onError</span><span class="token punctuation">(</span>
      <span class="token function">createCompilerError</span><span class="token punctuation">(</span>ErrorCodes<span class="token punctuation">.</span><span class="token constant">X_V_IF_NO_EXPRESSION</span><span class="token punctuation">,</span> dir<span class="token punctuation">.</span>loc<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    dir<span class="token punctuation">.</span>exp <span class="token operator">=</span> <span class="token function">createSimpleExpression</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">true</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> loc<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>__BROWSER__ <span class="token operator">&amp;&amp;</span> context<span class="token punctuation">.</span>prefixIdentifiers <span class="token operator">&amp;&amp;</span> dir<span class="token punctuation">.</span>exp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// dir.exp can only be simple expression because vIf transform is applied</span>
    <span class="token comment">// before expression transform.</span>
    dir<span class="token punctuation">.</span>exp <span class="token operator">=</span> <span class="token function">processExpression</span><span class="token punctuation">(</span>dir<span class="token punctuation">.</span>exp <span class="token keyword">as</span> SimpleExpressionNode<span class="token punctuation">,</span> context<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>dir<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'if'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> branch <span class="token operator">=</span> <span class="token function">createIfBranch</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> dir<span class="token punctuation">)</span>
    <span class="token keyword">const</span> ifNode<span class="token operator">:</span> IfNode <span class="token operator">=</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">IF</span><span class="token punctuation">,</span>
      loc<span class="token operator">:</span> node<span class="token punctuation">.</span>loc<span class="token punctuation">,</span>
      branches<span class="token operator">:</span> <span class="token punctuation">[</span>branch<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    context<span class="token punctuation">.</span><span class="token function">replaceNode</span><span class="token punctuation">(</span>ifNode<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>processCodegen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">processCodegen</span><span class="token punctuation">(</span>ifNode<span class="token punctuation">,</span> branch<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

contex <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function">replaceNode</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">/* istanbul ignore if */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>context<span class="token punctuation">.</span>currentNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Node being replaced is already removed.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>context<span class="token punctuation">.</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Cannot replace root node.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      context<span class="token punctuation">.</span>parent<span class="token operator">!</span><span class="token punctuation">.</span>children<span class="token punctuation">[</span>context<span class="token punctuation">.</span>childIndex<span class="token punctuation">]</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>currentNode <span class="token operator">=</span> node
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">createIfBranch</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token operator">:</span> ElementNode<span class="token punctuation">,</span> dir<span class="token operator">:</span> DirectiveNode</span><span class="token punctuation">)</span><span class="token operator">:</span> IfBranchNode <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">IF_BRANCH</span><span class="token punctuation">,</span>
    loc<span class="token operator">:</span> node<span class="token punctuation">.</span>loc<span class="token punctuation">,</span>
    condition<span class="token operator">:</span> dir<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'else'</span> <span class="token operator">?</span> <span class="token keyword">undefined</span> <span class="token operator">:</span> dir<span class="token punctuation">.</span>exp<span class="token punctuation">,</span>
    children<span class="token operator">:</span> node<span class="token punctuation">.</span>tagType <span class="token operator">===</span> ElementTypes<span class="token punctuation">.</span><span class="token constant">TEMPLATE</span> <span class="token operator">?</span> node<span class="token punctuation">.</span>children <span class="token operator">:</span> <span class="token punctuation">[</span>node<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br></div></div><p>我们先开看看 processCodegen，首先 processCodegen 不做什么，除了返回 exitfn 外。 vif 的 name 为 if 在 transform 的 nodeTransforms 之后，首先会被 switch 处理，这时他首先会被 NodeTypes.IF 捕获，这时调用 traverseNode 去遍历他的 node.branches，然后他的 branch 被遍历的时候，又被 IF_BRANCH 捕获，从而遍历   IF_BRANCH 的 children，即原来下面的 v-if 指令下原来的节点。从上面就可以看到为什么要在 createStructuralDirectiveTransform 中把 v-if 指令从 props 删除了，不然那就真的递归死循环了。</p> <p>在 vif 处理完毕之后，我们的 exitfn 开始被调用。对于 isRoot 来说，通过 createCodegenNodeForBranch 去创建 codegenNode。</p> <p>createCodegenNodeForBranch 中，对于 branch.condition 不为空的，创建  createConditionalExpression 的 AST 节点。对于 createConditionalExpression 节点，需要注意的是，test 是表示分支的条件，consequent 表示分支条件成立时，要运行的 codeGenNode，这里调用 createChildrenCodegenNode 去创建，而 alternate 表示分支条件不成立时，要运行的分支，默认是新建一个注释，因为 if 后面不一定有其他分支，同时我们为了 vdom  结构的稳定性。如果 if 分支后面还有有其他 else-if 、else，alternate 会被覆盖。从非 isRoot 就可以看出，对于其他分支，首先拿到 if 分支的 AST，然后判断 alternate 是不是 JS_CONDITIONAL_EXPRESSION，我们要拿到最后一个不是 JS_CONDITIONAL_EXPRESSION 的 AST，即这时的 AST 是 CallExpression ，这时我们通过 createCodegenNodeForBranch 去创建 AST，从可以看到 v-if 指令的 AST，是通过 alternate 把所有的条件链接起来的，有点像链表，而处于这个链表最顶端的，是 name 为 if 的分支。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token parameter">ifNode<span class="token punctuation">,</span> branch<span class="token punctuation">,</span> isRoot</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// Exit callback. Complete the codegenNode when all children have been</span>
      <span class="token comment">// transformed.</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          ifNode<span class="token punctuation">.</span>codegenNode <span class="token operator">=</span> <span class="token function">createCodegenNodeForBranch</span><span class="token punctuation">(</span>
            branch<span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            context
          <span class="token punctuation">)</span> <span class="token keyword">as</span> IfConditionalExpression
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// attach this branch's codegen node to the v-if root.</span>
          <span class="token keyword">let</span> parentCondition <span class="token operator">=</span> ifNode<span class="token punctuation">.</span>codegenNode<span class="token operator">!</span>
          <span class="token keyword">while</span> <span class="token punctuation">(</span>
            parentCondition<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>type <span class="token operator">===</span>
            NodeTypes<span class="token punctuation">.</span><span class="token constant">JS_CONDITIONAL_EXPRESSION</span>
          <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            parentCondition <span class="token operator">=</span> parentCondition<span class="token punctuation">.</span>alternate
          <span class="token punctuation">}</span>
          parentCondition<span class="token punctuation">.</span>alternate <span class="token operator">=</span> <span class="token function">createCodegenNodeForBranch</span><span class="token punctuation">(</span>
            branch<span class="token punctuation">,</span>
            ifNode<span class="token punctuation">.</span>branches<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span>
            context
          <span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">createCodegenNodeForBranch</span><span class="token punctuation">(</span>
  <span class="token parameter">branch<span class="token operator">:</span> IfBranchNode<span class="token punctuation">,</span>
  index<span class="token operator">:</span> number<span class="token punctuation">,</span>
  context<span class="token operator">:</span> TransformContext</span>
<span class="token punctuation">)</span><span class="token operator">:</span> IfConditionalExpression <span class="token operator">|</span> BlockCodegenNode <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>branch<span class="token punctuation">.</span>condition<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">createConditionalExpression</span><span class="token punctuation">(</span>
      branch<span class="token punctuation">.</span>condition<span class="token punctuation">,</span>
      <span class="token function">createChildrenCodegenNode</span><span class="token punctuation">(</span>branch<span class="token punctuation">,</span> index<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">// make sure to pass in asBlock: true so that the comment node call</span>
      <span class="token comment">// closes the current block.</span>
      <span class="token function">createCallExpression</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">helper</span><span class="token punctuation">(</span><span class="token constant">CREATE_COMMENT</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
        __DEV__ <span class="token operator">?</span> <span class="token string">'&quot;v-if&quot;'</span> <span class="token operator">:</span> <span class="token string">'&quot;&quot;'</span><span class="token punctuation">,</span>
        <span class="token string">'true'</span>
      <span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token keyword">as</span> IfConditionalExpression
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">createChildrenCodegenNode</span><span class="token punctuation">(</span>branch<span class="token punctuation">,</span> index<span class="token punctuation">,</span> context<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createConditionalExpression</span><span class="token punctuation">(</span>
  test<span class="token operator">:</span> ConditionalExpression<span class="token punctuation">[</span><span class="token string">'test'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  consequent<span class="token operator">:</span> ConditionalExpression<span class="token punctuation">[</span><span class="token string">'consequent'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  alternate<span class="token operator">:</span> ConditionalExpression<span class="token punctuation">[</span><span class="token string">'alternate'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  newline <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token punctuation">)</span><span class="token operator">:</span> ConditionalExpression <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">JS_CONDITIONAL_EXPRESSION</span><span class="token punctuation">,</span>
    test<span class="token punctuation">,</span>
    consequent<span class="token punctuation">,</span>
    alternate<span class="token punctuation">,</span>
    newline<span class="token punctuation">,</span>
    loc<span class="token operator">:</span> locStub
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br></div></div><p>我们回到 processIf 中的 else，即 name 不是 if 的分支，我们从上面知道其他分支都要挂载到 if 分支下面，那具体是怎么挂载的呢？</p> <p>首先找到当前节点所有相邻节点，这个通过 parent 去拿它的 children，然后找到当前节点的索引，我们假设如果存在 if节点，那么他一定在当前节点的前面，所以我们往前面开始遍历。遇到注释节点，就把他移除，同时塞进 comments。如果遇到了 NodeTypes.IF 节点，那就太好了，他就是我们要找的节点。我们首先把当前节点从父节点那里移除掉，然后给当前节点创建分支，然后塞到 NodeTypes.IF 的 branch 里面，再调用 processCodegen 生成 onExit，前面我们知道，注意这是 processCodegen 最后参数为 false， 他传入的 sibling 就是 顶部的 if node，这样让我们 codegenNode 通过 alternate 把不同分支链接起来。还有就是，我们的当前 node 被移除了，也就是说，它在 nodesTransforms 中的循环提前终止了，但是它还有其他需要转化啊，所以需要手动调用 traverseNode 去遍历，他会落到 switch 中的 IF_BRANCH 分支中。还有一点，就是其他分支不会返回 exitFn，因为循环终止了，就算返回也不会被调用，所以 exitFn 也手动调用。</p> <p>那如果找不到 if 分支呢？ 上报 <code>ErrorCodes.X_V_ELSE_NO_ADJACENT_IF</code> 错误。而对于这个循环来说，只要当前节点前面的节点不是注释分支，都会直接 break，也许会疑问，为什么不能是其他分支呢？其他分支都在前面从父节点移除了啊。</p> <p>注意对于一开始 <code>dir.name === 'if'</code> 来说，当它回到 traverseNode 时，它是 NodeTypes.IF 类型，然后我们会遍历它的 branches，其实他的branch 这时只有 if 一个分支，遍历 if 分支的时候，又掉入了 NodeTypes.IF_BRANCH 中。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// locate the adjacent v-if</span>
    <span class="token keyword">const</span> siblings <span class="token operator">=</span> context<span class="token punctuation">.</span>parent<span class="token operator">!</span><span class="token punctuation">.</span>children
    <span class="token keyword">const</span> comments <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">let</span> i <span class="token operator">=</span> siblings<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span> <span class="token operator">&gt;=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> sibling <span class="token operator">=</span> siblings<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__ <span class="token operator">&amp;&amp;</span> sibling <span class="token operator">&amp;&amp;</span> sibling<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">COMMENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        context<span class="token punctuation">.</span><span class="token function">removeNode</span><span class="token punctuation">(</span>sibling<span class="token punctuation">)</span>
        comments<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>sibling<span class="token punctuation">)</span>
        <span class="token keyword">continue</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>sibling <span class="token operator">&amp;&amp;</span> sibling<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">IF</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// move the node to the if node's branches</span>
        context<span class="token punctuation">.</span><span class="token function">removeNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> branch <span class="token operator">=</span> <span class="token function">createIfBranch</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> dir<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__ <span class="token operator">&amp;&amp;</span> comments<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          branch<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>comments<span class="token punctuation">,</span> <span class="token operator">...</span>branch<span class="token punctuation">.</span>children<span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
        sibling<span class="token punctuation">.</span>branches<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>branch<span class="token punctuation">)</span>
        <span class="token keyword">const</span> onExit <span class="token operator">=</span> processCodegen <span class="token operator">&amp;&amp;</span> <span class="token function">processCodegen</span><span class="token punctuation">(</span>sibling<span class="token punctuation">,</span> branch<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
        <span class="token comment">// since the branch was removed, it will not be traversed.</span>
        <span class="token comment">// make sure to traverse here.</span>
        <span class="token function">traverseNode</span><span class="token punctuation">(</span>branch<span class="token punctuation">,</span> context<span class="token punctuation">)</span>
        <span class="token comment">// call on exit</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>onExit<span class="token punctuation">)</span> <span class="token function">onExit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// make sure to reset currentNode after traversal to indicate this</span>
        <span class="token comment">// node has been removed.</span>
        context<span class="token punctuation">.</span>currentNode <span class="token operator">=</span> <span class="token keyword">null</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        context<span class="token punctuation">.</span><span class="token function">onError</span><span class="token punctuation">(</span>
          <span class="token function">createCompilerError</span><span class="token punctuation">(</span>ErrorCodes<span class="token punctuation">.</span><span class="token constant">X_V_ELSE_NO_ADJACENT_IF</span><span class="token punctuation">,</span> node<span class="token punctuation">.</span>loc<span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">break</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>对于 vIf，只剩下 createCodegenNodeForBranch 还没讲。我们知道这个方法是在 exitFn 上面调用，用于生成 codeGenNode的。下面我们知道，除了 else 分支，返回的 都是 createConditionalExpression，这也是为了链接不同分支。而不管是什么分支，最终真正意义上的 codeGenNode 都是通过 createChildrenCodegenNode 创建。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createCodegenNodeForBranch</span><span class="token punctuation">(</span>
  <span class="token parameter">branch<span class="token operator">:</span> IfBranchNode<span class="token punctuation">,</span>
  index<span class="token operator">:</span> number<span class="token punctuation">,</span>
  context<span class="token operator">:</span> TransformContext</span>
<span class="token punctuation">)</span><span class="token operator">:</span> IfConditionalExpression <span class="token operator">|</span> BlockCodegenNode <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>branch<span class="token punctuation">.</span>condition<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">createConditionalExpression</span><span class="token punctuation">(</span>
      branch<span class="token punctuation">.</span>condition<span class="token punctuation">,</span>
      <span class="token function">createChildrenCodegenNode</span><span class="token punctuation">(</span>branch<span class="token punctuation">,</span> index<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">// make sure to pass in asBlock: true so that the comment node call</span>
      <span class="token comment">// closes the current block.</span>
      <span class="token function">createCallExpression</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">helper</span><span class="token punctuation">(</span><span class="token constant">CREATE_COMMENT</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
        __DEV__ <span class="token operator">?</span> <span class="token string">'&quot;v-if&quot;'</span> <span class="token operator">:</span> <span class="token string">'&quot;&quot;'</span><span class="token punctuation">,</span>
        <span class="token string">'true'</span>
      <span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token keyword">as</span> IfConditionalExpression
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">createChildrenCodegenNode</span><span class="token punctuation">(</span>branch<span class="token punctuation">,</span> index<span class="token punctuation">,</span> context<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>那就来看看 createChildrenCodegenNode，这里说白了就是为了建立 Block tree 。首先我们创建 keyProperty ，用于优化  diff，会被注入到我们生成的 codeGenNode 中。接着我们拿出分支中的第一个child firstChild。我们先判断 children 需不需被 FRAGMENT 包住，如果 children 长度不为 1 或者 长度为1但第一个元素类似不是 NodeTypes.ELEMENT 时，可能需要用 FRAGMENT 包住，注意 patchFlag 为 STABLE_FRAGMENT，diff 时 要用到。但是有个例外，就是只有一个元素且元素是 NodeTypes.FOR 类型，这时候我们不需要包住，因为 FOR 类型本身都要 FRAGMENT 包住了。</p> <p>而对于不需要FRAGMENT 包住的 else 分支，即chidren 长度为 1 且 type 为 NodeTypes.ELEMENT，我们需要取出 firstChild 的 codegenNode，VNODE_CALL 类型是在 parseElement 时候生成的，codegenNode 也是那时候生成的，就是用于创建 VNode, 对于类型是 VNODE_CALL，对于 tagType 是 COMPONENT 且 tag 是 TELEPORT、或者根据 parse 的生成的 tagType 还可能是 slot、template、element，需要用 block 包住，会标记 isBlock 为 true ，同时为 runtime 注入两个方法。tagType 是 COMPONENT 的其他 Tag 默认 isBlock 为 true 了。至于 block 干嘛用的，就是用于加速 diff 时，对于动态节点的优化，就是传闻中的 block tree，diff 时只对 block 部分进行 diff，毕竟 动态节点中也有不变的部分，但这部分又不能被 hoist 也不需要被 diff，通过 block 我们可以跳过这部分的 diff。</p> <p>注意对于 createVNodeCall 倒数第二个参数为 false，表示不是 isForBlock, 因为 对于 forBlock 来说，我们希望他被 full diff,因为对于 forBlock 来说中间的 child 的循序可能会打乱，block tree 需要顺序和结构稳定，而 forBlcok 为 true，在 runtime 的时候，会让 currentBlock 为 null 的，也就是他不会直接收集自己下面的动态节点，我们只能通过 full diff 的时候，或许下面有节点有 block tree ，只能在这时下面的节点才能走快速 diff 通道。</p> <p>可能这块看的有点懵，主要是 diff 这块还没讲，可以先看着先，后续会讲到。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createChildrenCodegenNode</span><span class="token punctuation">(</span>
  <span class="token parameter">branch<span class="token operator">:</span> IfBranchNode<span class="token punctuation">,</span>
  index<span class="token operator">:</span> number<span class="token punctuation">,</span>
  context<span class="token operator">:</span> TransformContext</span>
<span class="token punctuation">)</span><span class="token operator">:</span> BlockCodegenNode <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> helper <span class="token punctuation">}</span> <span class="token operator">=</span> context
  <span class="token keyword">const</span> keyProperty <span class="token operator">=</span> <span class="token function">createObjectProperty</span><span class="token punctuation">(</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">key</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token function">createSimpleExpression</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> children <span class="token punctuation">}</span> <span class="token operator">=</span> branch
  <span class="token keyword">const</span> firstChild <span class="token operator">=</span> children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> needFragmentWrapper <span class="token operator">=</span>
    children<span class="token punctuation">.</span>length <span class="token operator">!==</span> <span class="token number">1</span> <span class="token operator">||</span> firstChild<span class="token punctuation">.</span>type <span class="token operator">!==</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">ELEMENT</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>needFragmentWrapper<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>children<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> firstChild<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">FOR</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// optimize away nested fragments when child is a ForNode</span>
      <span class="token keyword">const</span> vnodeCall <span class="token operator">=</span> firstChild<span class="token punctuation">.</span>codegenNode<span class="token operator">!</span>
      <span class="token function">injectProp</span><span class="token punctuation">(</span>vnodeCall<span class="token punctuation">,</span> keyProperty<span class="token punctuation">,</span> context<span class="token punctuation">)</span>
      <span class="token keyword">return</span> vnodeCall
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">createVNodeCall</span><span class="token punctuation">(</span>
        context<span class="token punctuation">,</span>
        <span class="token function">helper</span><span class="token punctuation">(</span><span class="token constant">FRAGMENT</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">createObjectExpression</span><span class="token punctuation">(</span><span class="token punctuation">[</span>keyProperty<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        children<span class="token punctuation">,</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>PatchFlags<span class="token punctuation">.</span><span class="token constant">STABLE_FRAGMENT</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> /* </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
          PatchFlagNames<span class="token punctuation">[</span>PatchFlags<span class="token punctuation">.</span><span class="token constant">STABLE_FRAGMENT</span><span class="token punctuation">]</span>
        <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> */</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token keyword">undefined</span><span class="token punctuation">,</span>
        <span class="token keyword">undefined</span><span class="token punctuation">,</span>
        <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token boolean">false</span><span class="token punctuation">,</span>
        branch<span class="token punctuation">.</span>loc
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> vnodeCall <span class="token operator">=</span> <span class="token punctuation">(</span>firstChild <span class="token keyword">as</span> ElementNode<span class="token punctuation">)</span>
      <span class="token punctuation">.</span>codegenNode <span class="token keyword">as</span> BlockCodegenNode
    <span class="token comment">// Change createVNode to createBlock.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      vnodeCall<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">VNODE_CALL</span> <span class="token operator">&amp;&amp;</span>
      <span class="token comment">// component vnodes are always tracked and its children are</span>
      <span class="token comment">// compiled into slots so no need to make it a block</span>
      <span class="token punctuation">(</span><span class="token punctuation">(</span>firstChild <span class="token keyword">as</span> ElementNode<span class="token punctuation">)</span><span class="token punctuation">.</span>tagType <span class="token operator">!==</span> ElementTypes<span class="token punctuation">.</span><span class="token constant">COMPONENT</span> <span class="token operator">||</span>
        <span class="token comment">// teleport has component type but isn't always tracked</span>
        vnodeCall<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token constant">TELEPORT</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      vnodeCall<span class="token punctuation">.</span>isBlock <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token function">helper</span><span class="token punctuation">(</span><span class="token constant">OPEN_BLOCK</span><span class="token punctuation">)</span>
      <span class="token function">helper</span><span class="token punctuation">(</span><span class="token constant">CREATE_BLOCK</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// inject branch key</span>
    <span class="token function">injectProp</span><span class="token punctuation">(</span>vnodeCall<span class="token punctuation">,</span> keyProperty<span class="token punctuation">,</span> context<span class="token punctuation">)</span>
    <span class="token keyword">return</span> vnodeCall
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><p>总结，对于 vIf 来说，NodeTypes.IF 节点是所有分支的容器，通过 branches 挂载着不同的分支，每个分支就是 NodeTypes.IF_BRANCH，所有分支的 codeGenNode 都是通过容器相链接，通过 alternate 链接到下一个 codeGenNode。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/slamdunk-the-vue3/main/vue/compiler/transform/vOnce.html" class="prev">
        vOnce
      </a></span> <span class="next"><a href="/slamdunk-the-vue3/main/vue/compiler/codegen.html">
        codegen
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/slamdunk-the-vue3/assets/js/app.19f0a9f3.js" defer></script><script src="/slamdunk-the-vue3/assets/js/2.43eface2.js" defer></script><script src="/slamdunk-the-vue3/assets/js/14.a192b497.js" defer></script>
  </body>
</html>
