<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Vue3.0 源码解读</title>
    <meta name="generator" content="VuePress 1.4.1">
    <link rel="icon" href="/slamdunk-the-vue3/onepunch.jpeg">
    <script src="https://hm.baidu.com/hm.js?4484bd6412288feacc311fd7f2054116"></script>
    <meta name="description" content="Vue3.0 源码解读">
    <link rel="preload" href="/slamdunk-the-vue3/assets/css/0.styles.8a77ab8b.css" as="style"><link rel="preload" href="/slamdunk-the-vue3/assets/js/app.dea22f88.js" as="script"><link rel="preload" href="/slamdunk-the-vue3/assets/js/2.43eface2.js" as="script"><link rel="preload" href="/slamdunk-the-vue3/assets/js/13.64717b64.js" as="script"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/10.ce270f70.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/11.1a015dc8.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/12.3286883d.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/14.206ed943.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/15.77afe700.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/16.e3742f57.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/17.1e6994cd.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/18.aa67dea2.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/19.6aa0a648.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/20.3f65b4d6.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/21.1c13a471.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/22.931f90d4.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/23.175af59a.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/24.f8507621.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/3.350504d2.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/4.ce76527a.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/5.8846d71d.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/6.04c70b96.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/7.171c11ae.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/8.40d7a914.js"><link rel="prefetch" href="/slamdunk-the-vue3/assets/js/9.a7a94907.js">
    <link rel="stylesheet" href="/slamdunk-the-vue3/assets/css/0.styles.8a77ab8b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/slamdunk-the-vue3/" class="home-link router-link-active"><!----> <span class="site-name">Vue3.0 源码解读</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/slamdunk-the-vue3/main/" class="nav-link router-link-active">
  Vue 3.0 解读
</a></div><div class="nav-item"><a href="/slamdunk-the-vue3/about.html" class="nav-link">
  关于我
</a></div><div class="nav-item"><a href="https://github.com/hkc452/slamdunk-the-vue3" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/slamdunk-the-vue3/main/" class="nav-link router-link-active">
  Vue 3.0 解读
</a></div><div class="nav-item"><a href="/slamdunk-the-vue3/about.html" class="nav-link">
  关于我
</a></div><div class="nav-item"><a href="https://github.com/hkc452/slamdunk-the-vue3" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>响应式系统</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/slamdunk-the-vue3/main/vue/reactivity/effect.html" class="sidebar-link">effect</a></li><li><a href="/slamdunk-the-vue3/main/vue/reactivity/reactive.html" class="sidebar-link">reactive</a></li><li><a href="/slamdunk-the-vue3/main/vue/reactivity/baseHandlers.html" class="sidebar-link">baseHandlers</a></li><li><a href="/slamdunk-the-vue3/main/vue/reactivity/collectionHandlers.html" class="sidebar-link">collectionHandlers</a></li><li><a href="/slamdunk-the-vue3/main/vue/reactivity/ref.html" class="sidebar-link">ref</a></li><li><a href="/slamdunk-the-vue3/main/vue/reactivity/computed.html" class="sidebar-link">computed</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>编译模块</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/slamdunk-the-vue3/main/vue/compiler/compiler.html" class="sidebar-link">compiler</a></li><li><a href="/slamdunk-the-vue3/main/vue/compiler/parse.html" class="sidebar-link">parse</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>transform(正在施工🚧)</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/slamdunk-the-vue3/main/vue/compiler/transform.html" class="active sidebar-link">transform</a></li><li><a href="/slamdunk-the-vue3/main/vue/compiler/transform/vOnce.html" class="sidebar-link">vOnce</a></li><li><a href="/slamdunk-the-vue3/main/vue/compiler/transform/vIf.html" class="sidebar-link">vIf</a></li></ul></section></li><li><a href="/slamdunk-the-vue3/main/vue/compiler/codegen.html" class="sidebar-link">codegen</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>transform 可以说是整个编译模块最复杂庞大的部分，需要对 parse 阶段生成的 AST 节点进行二次分析以及根据 Vue 语法和优化等需要，需要对节点进行调整，从而为最后的 codegen 最后热身准备。</p> <p>我们首先从 complier-dom 的 compile 方法 看到 compiler-core 的 baseCompile 方法。 compiler-dom, 只传入了 transformStyle 的 nodeTransforms，同时传入了 一堆的 DOMDirectiveTransforms 。而 compiler-core 中 通过 getBaseTransformPreset 生成了系列 nodeTransforms 和 directiveTransforms， 同时 传入的 transform 都排在 core 的后面，为什么要提这一点呢？因为对于 transform 来说， 顺序很重要，对于 directiveTransforms 没有影响，因为这是对指令的转化，而对于 nodeTransforms 而言，涉及到对 node 节点的转化，同时 node 节点的转化的过程类似 koa 中的洋葱模型，因为每个 nodeTransform 都有类似 enter 和 exit 事件，第一个执行的 nodeTransform 它的 exit 事件最后执行。</p> <p>在下面我们也可以同时看出，baseParse 解析生成的 AST 节点，将会传入 compile 进行转化。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// compiler-dom</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> DOMNodeTransforms<span class="token operator">:</span> NodeTransform<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  transformStyle<span class="token punctuation">,</span>
  <span class="token operator">...</span><span class="token punctuation">(</span>__DEV__ <span class="token operator">?</span> <span class="token punctuation">[</span>warnTransitionChildren<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> DOMDirectiveTransforms<span class="token operator">:</span> Record<span class="token operator">&lt;</span>string<span class="token punctuation">,</span> DirectiveTransform<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  cloak<span class="token operator">:</span> noopDirectiveTransform<span class="token punctuation">,</span>
  html<span class="token operator">:</span> transformVHtml<span class="token punctuation">,</span>
  text<span class="token operator">:</span> transformVText<span class="token punctuation">,</span>
  model<span class="token operator">:</span> transformModel<span class="token punctuation">,</span> <span class="token comment">// override compiler-core</span>
  on<span class="token operator">:</span> transformOn<span class="token punctuation">,</span> <span class="token comment">// override compiler-core</span>
  show<span class="token operator">:</span> transformShow
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">compile</span><span class="token punctuation">(</span>
  <span class="token parameter">template<span class="token operator">:</span> string<span class="token punctuation">,</span>
  options<span class="token operator">:</span> CompilerOptions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> CodegenResult <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">baseCompile</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>parserOptions<span class="token punctuation">,</span>
    <span class="token operator">...</span>options<span class="token punctuation">,</span>
    nodeTransforms<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">...</span>DOMNodeTransforms<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>nodeTransforms <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    directiveTransforms<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>DOMDirectiveTransforms<span class="token punctuation">,</span>
      <span class="token operator">...</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>directiveTransforms <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    transformHoist<span class="token operator">:</span> __BROWSER__ <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> stringifyStatic
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// compiler-core</span>
<span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">isString</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">baseParse</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> options<span class="token punctuation">)</span> <span class="token operator">:</span> template
<span class="token keyword">const</span> <span class="token punctuation">[</span>nodeTransforms<span class="token punctuation">,</span> directiveTransforms<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">getBaseTransformPreset</span><span class="token punctuation">(</span>
    prefixIdentifiers
<span class="token punctuation">)</span>
<span class="token function">transform</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>options<span class="token punctuation">,</span>
    prefixIdentifiers<span class="token punctuation">,</span>
    nodeTransforms<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token operator">...</span>nodeTransforms<span class="token punctuation">,</span>
      <span class="token operator">...</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>nodeTransforms <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// user transforms</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    directiveTransforms<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>directiveTransforms<span class="token punctuation">,</span>
      <span class="token operator">...</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>directiveTransforms <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// user transforms</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><p>那接下来我们先看看 transform 到底干了啥，为什么还需要这么多插件呢。可以看到 Vue 里面的代码风格还是很一致的，首先生成解析的上下文 context，然后调用 traverseNode 去遍历转化我们 node，然后 要不要对我们的 hoist 进行转化，还有生成 Root 节点的 codegenNode，codegenNode 看名字就知道是用于 codegen 时使用的。至于最后的  meta information，我们在 traverseNode 的时候，会对 context 进行赋值，最后会把 context 的值赋给 Root，这个参数干嘛的呢，举个栗子， helpers 就是 runtime 需要引入的 runtime 方法，我们在这里存好，方便在 codegen 的时候引入进来。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token operator">:</span> RootNode<span class="token punctuation">,</span> options<span class="token operator">:</span> TransformOptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token function">createTransformContext</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
  <span class="token function">traverseNode</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> context<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>hoistStatic<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">hoistStatic</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> context<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>ssr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">createRootCodegen</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> context<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// finalize meta information</span>
  root<span class="token punctuation">.</span>helpers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>context<span class="token punctuation">.</span>helpers<span class="token punctuation">]</span>
  root<span class="token punctuation">.</span>components <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>context<span class="token punctuation">.</span>components<span class="token punctuation">]</span>
  root<span class="token punctuation">.</span>directives <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>context<span class="token punctuation">.</span>directives<span class="token punctuation">]</span>
  root<span class="token punctuation">.</span>imports <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>context<span class="token punctuation">.</span>imports<span class="token punctuation">]</span>
  root<span class="token punctuation">.</span>hoists <span class="token operator">=</span> context<span class="token punctuation">.</span>hoists
  root<span class="token punctuation">.</span>temps <span class="token operator">=</span> context<span class="token punctuation">.</span>temps
  root<span class="token punctuation">.</span>cached <span class="token operator">=</span> context<span class="token punctuation">.</span>cached
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>下面我们先看看 createTransformContext，相比于 parse 的上下文来说，这个还是蛮复杂的。不过，从下面的源码中，我们也可以大致看到几个分类，options、state 和 methods。</p> <p>options 中有些已经说过了，这里挑几个没讲过的，cacheHandlers 就是要不要缓存函数的，<code>{ onClick: _cache[0] || (_cache[0] = e =&gt; _ctx.foo(e)) }</code>，这个在 compiler 时候参数校验说过， expressionPlugins 是用于 transformExpressions 时，<code>@babel/parse</code> 的插件。</p> <p>state 主要是用于存放 transform 需要的全局变量，用于状态的保存。scopes 里面有几个环境，for、slot、pre、once，这里用计数来标记所处的环境，是因为存在嵌套的情况。identifiers 表示用到变量，主要防止变量冲突，同时采用计数的原因，也有点像垃圾回收。temps、cached 分辨表示临时变量 和 缓存变量，这里用数字表示，是把这两个数当成了索引坐标。这与hoists 有点类似，不过 hoists 是拿数组长度做下标，hoists 主要是存放静态节点，至于 temps、cached 、hoists 三者细致的区别，后续会讲到。最后提一下, parent 表示 父级 AST， currentNode 表示 当前正在处理的 node，childIndex 表示当前节点处于父级的 index，方便进行节点删除等操作。</p> <p>而 methods 主要用于操作 state 以及 节点进行节本的操作。这里面用到的方法，会在 traverseNode 做讲解。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createTransformContext</span><span class="token punctuation">(</span>
  <span class="token parameter">root<span class="token operator">:</span> RootNode<span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    prefixIdentifiers <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    hoistStatic <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    cacheHandlers <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    nodeTransforms <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    directiveTransforms <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    transformHoist <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    isBuiltInComponent <span class="token operator">=</span> <span class="token constant">NOOP</span><span class="token punctuation">,</span>
    expressionPlugins <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    scopeId <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    ssr <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    onError <span class="token operator">=</span> defaultOnError
  <span class="token punctuation">}</span><span class="token operator">:</span> TransformOptions</span>
<span class="token punctuation">)</span><span class="token operator">:</span> TransformContext <span class="token punctuation">{</span>
  <span class="token keyword">const</span> context<span class="token operator">:</span> TransformContext <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// options</span>
    prefixIdentifiers<span class="token punctuation">,</span>
    hoistStatic<span class="token punctuation">,</span>
    cacheHandlers<span class="token punctuation">,</span>
    nodeTransforms<span class="token punctuation">,</span>
    directiveTransforms<span class="token punctuation">,</span>
    transformHoist<span class="token punctuation">,</span>
    isBuiltInComponent<span class="token punctuation">,</span>
    expressionPlugins<span class="token punctuation">,</span>
    scopeId<span class="token punctuation">,</span>
    ssr<span class="token punctuation">,</span>
    onError<span class="token punctuation">,</span>

    <span class="token comment">// state</span>
    root<span class="token punctuation">,</span>
    helpers<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    components<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    directives<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    hoists<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    imports<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    temps<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    cached<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    identifiers<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    scopes<span class="token operator">:</span> <span class="token punctuation">{</span>
      vFor<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      vSlot<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      vPre<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      vOnce<span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    parent<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    currentNode<span class="token operator">:</span> root<span class="token punctuation">,</span>
    childIndex<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>

    <span class="token comment">// methods</span>
    <span class="token function">helper</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      context<span class="token punctuation">.</span>helpers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
      <span class="token keyword">return</span> name
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">helperString</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>helperNameMap<span class="token punctuation">[</span>context<span class="token punctuation">.</span><span class="token function">helper</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">replaceNode</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">/* istanbul ignore if */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>context<span class="token punctuation">.</span>currentNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Node being replaced is already removed.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>context<span class="token punctuation">.</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Cannot replace root node.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      context<span class="token punctuation">.</span>parent<span class="token operator">!</span><span class="token punctuation">.</span>children<span class="token punctuation">[</span>context<span class="token punctuation">.</span>childIndex<span class="token punctuation">]</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>currentNode <span class="token operator">=</span> node
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">removeNode</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__ <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>context<span class="token punctuation">.</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Cannot remove root node.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">const</span> list <span class="token operator">=</span> context<span class="token punctuation">.</span>parent<span class="token operator">!</span><span class="token punctuation">.</span>children
      <span class="token keyword">const</span> removalIndex <span class="token operator">=</span> node
        <span class="token operator">?</span> list<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>
        <span class="token operator">:</span> context<span class="token punctuation">.</span>currentNode
          <span class="token operator">?</span> context<span class="token punctuation">.</span>childIndex
          <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span>
      <span class="token comment">/* istanbul ignore if */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__ <span class="token operator">&amp;&amp;</span> removalIndex <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">node being removed is not a child of current parent</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>node <span class="token operator">||</span> node <span class="token operator">===</span> context<span class="token punctuation">.</span>currentNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// current node removed</span>
        context<span class="token punctuation">.</span>currentNode <span class="token operator">=</span> <span class="token keyword">null</span>
        context<span class="token punctuation">.</span><span class="token function">onNodeRemoved</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// sibling node removed</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>childIndex <span class="token operator">&gt;</span> removalIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          context<span class="token punctuation">.</span>childIndex<span class="token operator">--</span>
          context<span class="token punctuation">.</span><span class="token function">onNodeRemoved</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      context<span class="token punctuation">.</span>parent<span class="token operator">!</span><span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>removalIndex<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">onNodeRemoved</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">addIdentifiers</span><span class="token punctuation">(</span><span class="token parameter">exp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// identifier tracking only happens in non-browser builds.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>__BROWSER__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span>exp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">addId</span><span class="token punctuation">(</span>exp<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>exp<span class="token punctuation">.</span>identifiers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          exp<span class="token punctuation">.</span>identifiers<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>addId<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>exp<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">SIMPLE_EXPRESSION</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">addId</span><span class="token punctuation">(</span>exp<span class="token punctuation">.</span>content<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">removeIdentifiers</span><span class="token punctuation">(</span><span class="token parameter">exp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>__BROWSER__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span>exp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">removeId</span><span class="token punctuation">(</span>exp<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>exp<span class="token punctuation">.</span>identifiers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          exp<span class="token punctuation">.</span>identifiers<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>removeId<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>exp<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">SIMPLE_EXPRESSION</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">removeId</span><span class="token punctuation">(</span>exp<span class="token punctuation">.</span>content<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">hoist</span><span class="token punctuation">(</span><span class="token parameter">exp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      context<span class="token punctuation">.</span>hoists<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>exp<span class="token punctuation">)</span>
      <span class="token keyword">const</span> identifier <span class="token operator">=</span> <span class="token function">createSimpleExpression</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_hoisted_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>context<span class="token punctuation">.</span>hoists<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token boolean">false</span><span class="token punctuation">,</span>
        exp<span class="token punctuation">.</span>loc<span class="token punctuation">,</span>
        <span class="token boolean">true</span>
      <span class="token punctuation">)</span>
      identifier<span class="token punctuation">.</span>hoisted <span class="token operator">=</span> exp
      <span class="token keyword">return</span> identifier
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">cache</span><span class="token punctuation">(</span><span class="token parameter">exp<span class="token punctuation">,</span> isVNode <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">createCacheExpression</span><span class="token punctuation">(</span><span class="token operator">++</span>context<span class="token punctuation">.</span>cached<span class="token punctuation">,</span> exp<span class="token punctuation">,</span> isVNode<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">addId</span><span class="token punctuation">(</span><span class="token parameter">id<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> identifiers <span class="token punctuation">}</span> <span class="token operator">=</span> context
    <span class="token keyword">if</span> <span class="token punctuation">(</span>identifiers<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      identifiers<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>
    identifiers<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token operator">!</span><span class="token operator">++</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">removeId</span><span class="token punctuation">(</span><span class="token parameter">id<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    context<span class="token punctuation">.</span>identifiers<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token operator">!</span><span class="token operator">--</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> context
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br></div></div><p>再讲讲 transfrom ，对于 transfrom 插件而言，一共有两种类型的，下面的注释也写的很清楚，NodeTransform 主要是对 childNode 进行操作，可能会替换或者移动节点，而 DirectiveTransform 主要是对我们的指令进行转化生成 VNode 上面真实的 props。要记住这两种 transforms 的区别，因为这对于整个 transform 流程的理解至关重要。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>
<span class="token comment">// There are two types of transforms:</span>
<span class="token comment">//</span>
<span class="token comment">// - NodeTransform:</span>
<span class="token comment">//   Transforms that operate directly on a ChildNode. NodeTransforms may mutate,</span>
<span class="token comment">//   replace or remove the node being processed.</span>
<span class="token keyword">export</span> type <span class="token function-variable function">NodeTransform</span> <span class="token operator">=</span> <span class="token punctuation">(</span>
  <span class="token parameter">node<span class="token operator">:</span> RootNode <span class="token operator">|</span> TemplateChildNode<span class="token punctuation">,</span>
  context<span class="token operator">:</span> TransformContext</span>
<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token comment">// - DirectiveTransform:</span>
<span class="token comment">//   Transforms that handles a single directive attribute on an element.</span>
<span class="token comment">//   It translates the raw directive into actual props for the VNode.</span>
<span class="token keyword">export</span> type DirectiveTransform <span class="token operator">=</span> <span class="token punctuation">(</span>
  dir<span class="token operator">:</span> DirectiveNode<span class="token punctuation">,</span>
  node<span class="token operator">:</span> ElementNode<span class="token punctuation">,</span>
  context<span class="token operator">:</span> TransformContext<span class="token punctuation">,</span>
  <span class="token comment">// a platform specific compiler can import the base transform and augment</span>
  <span class="token comment">// it by passing in this optional argument.</span>
  augmentor<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">ret<span class="token operator">:</span> DirectiveTransformResult</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> DirectiveTransformResult
<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> DirectiveTransformResult

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">DirectiveTransformResult</span> <span class="token punctuation">{</span>
  props<span class="token operator">:</span> Property<span class="token punctuation">[</span><span class="token punctuation">]</span>
  needRuntime<span class="token operator">?</span><span class="token operator">:</span> boolean <span class="token operator">|</span> symbol
  ssrTagParts<span class="token operator">?</span><span class="token operator">:</span> TemplateLiteral<span class="token punctuation">[</span><span class="token string">'elements'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token comment">// A structural directive transform is a technically a NodeTransform;</span>
<span class="token comment">// Only v-if and v-for fall into this category.</span>
<span class="token keyword">export</span> type <span class="token function-variable function">StructuralDirectiveTransform</span> <span class="token operator">=</span> <span class="token punctuation">(</span>
  <span class="token parameter">node<span class="token operator">:</span> ElementNode<span class="token punctuation">,</span>
  dir<span class="token operator">:</span> DirectiveNode<span class="token punctuation">,</span>
  context<span class="token operator">:</span> TransformContext</span>
<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p>接下来我们看看 traverseNode，这是 transform 中的核心，控制整个流程的运转。首先要解析的节点赋值给 currentNode，现在解析一开始是 Root 节点，然后调用 nodeTransforms 循环，同时把 node 传进去，最后对于 nodeTransform 返回 onExit 处理的，塞到 exitFns 里面，在循环中，如果这个节点被移除了，直接 return 结束整个 traverseNode，如果没有被移除，  <code>node = context.currentNode</code> 通过这样重新拿 node， 因为在 transform 过程中，node 可以被替换了，所以要通过这种方式拿最新值。</p> <p>接着对根据 node 的类型进行处理，可以看到对于 comment 节点，<code>context.helper(CREATE_COMMENT)</code>，上面我们可以看到就是把 <code>CREATE_COMMENT</code> 这个方法塞到 <code>helpers</code> 这个 set 集合里面，为了 codegen 的时候把 runtime 的方法引入进来。对于插值也一样，把 runtime 的 <code>TO_DISPLAY_STRING</code> 引入进来，不过对于 ssr ，上面两个方法不需要引入，因为 ssr 在 transform 阶段就把这两个问题前置处理了，所以不需要 runtime。对于 type 为 NodeTypes.IF 类型，注意这个类型我们在 parse 阶段生成的类型是没有的，是在 transform 阶段生成的，这时递归调用 traverseNode 去处理每个分支 branches 。而对于 IF_BRANCH、FOR、ELEMENT、ROOT，则调用 traverseChildren 去处理子节点，我们一开始调用 traverseNode 是处于 ROOT，所以下面必回调用 traverseChildren 处理 ROOT 下面的children。switch 处理完毕后，看 exitFns 的调用，从 exitFns 数组的尾巴往前调用，这也是为什么前面我说很像洋葱模型的原因了。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">traverseNode</span><span class="token punctuation">(</span>
  <span class="token parameter">node<span class="token operator">:</span> RootNode <span class="token operator">|</span> TemplateChildNode<span class="token punctuation">,</span>
  context<span class="token operator">:</span> TransformContext</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  context<span class="token punctuation">.</span>currentNode <span class="token operator">=</span> node
  <span class="token comment">// apply transform plugins</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> nodeTransforms <span class="token punctuation">}</span> <span class="token operator">=</span> context
  <span class="token keyword">const</span> exitFns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nodeTransforms<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> onExit <span class="token operator">=</span> nodeTransforms<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> context<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>onExit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isArray</span><span class="token punctuation">(</span>onExit<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        exitFns<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>onExit<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        exitFns<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>onExit<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>context<span class="token punctuation">.</span>currentNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// node was removed</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// node may have been replaced</span>
      node <span class="token operator">=</span> context<span class="token punctuation">.</span>currentNode
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">switch</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">COMMENT</span><span class="token operator">:</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>context<span class="token punctuation">.</span>ssr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// inject import for the Comment symbol, which is needed for creating</span>
        <span class="token comment">// comment nodes with `createVNode`</span>
        context<span class="token punctuation">.</span><span class="token function">helper</span><span class="token punctuation">(</span><span class="token constant">CREATE_COMMENT</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">break</span>
    <span class="token keyword">case</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">INTERPOLATION</span><span class="token operator">:</span>
      <span class="token comment">// no need to traverse, but we need to inject toString helper</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>context<span class="token punctuation">.</span>ssr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        context<span class="token punctuation">.</span><span class="token function">helper</span><span class="token punctuation">(</span><span class="token constant">TO_DISPLAY_STRING</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">break</span>

    <span class="token comment">// for container types, further traverse downwards</span>
    <span class="token keyword">case</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">IF</span><span class="token operator">:</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> node<span class="token punctuation">.</span>branches<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">traverseNode</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>branches<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">break</span>
    <span class="token keyword">case</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">IF_BRANCH</span><span class="token operator">:</span>
    <span class="token keyword">case</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">FOR</span><span class="token operator">:</span>
    <span class="token keyword">case</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">ELEMENT</span><span class="token operator">:</span>
    <span class="token keyword">case</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">ROOT</span><span class="token operator">:</span>
      <span class="token function">traverseChildren</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> context<span class="token punctuation">)</span>
      <span class="token keyword">break</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// exit transforms</span>
  <span class="token keyword">let</span> i <span class="token operator">=</span> exitFns<span class="token punctuation">.</span>length
  <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    exitFns<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br></div></div><p>traverseNode 中的 switch 最后的分支，就是调用 traverseChildren 对子节点进行处理，在循环中，讲 传入的node 赋值 context.parent，这样在对 child 进行 移除替换操作时，能拿到 parent，同时 nodeRemoved 也是为了修正如果 child 被移除，下一次循环能从正确的位置开始，childIndex 是为了移除或者替换节点时能正确知道插入父节点的位置，最后递归调用 traverseNode 对 child 进行 transform 处理。<code>if (isString(child)) continue</code> 这个再说下，我们知道 parse 生成的节点都是 AST 节点，即对象，这是会出现 string 的原因，也是 transform 过程中，对 AST 节点进行了操作。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">traverseChildren</span><span class="token punctuation">(</span>
  <span class="token parameter">parent<span class="token operator">:</span> ParentNode<span class="token punctuation">,</span>
  context<span class="token operator">:</span> TransformContext</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">const</span> <span class="token function-variable function">nodeRemoved</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    i<span class="token operator">--</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> parent<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> child <span class="token operator">=</span> parent<span class="token punctuation">.</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">continue</span>
    context<span class="token punctuation">.</span>parent <span class="token operator">=</span> parent
    context<span class="token punctuation">.</span>childIndex <span class="token operator">=</span> i
    context<span class="token punctuation">.</span>onNodeRemoved <span class="token operator">=</span> nodeRemoved
    <span class="token function">traverseNode</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> context<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>我们可以看到，traverseNode 可以认为是空转，里面没有处理具体的逻辑，只是对 整个 transform 流程进行一个总体的流程把控。所以需要理解 transform，需要对 传入的 nodeTransform 进行讲解，同时再次强调的是，nodeTransforms 传入的顺序很重要，因为涉及到对 node 的优先处理，还有就是类洋葱模型的 exitFn。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/slamdunk-the-vue3/main/vue/compiler/parse.html" class="prev">
        parse
      </a></span> <span class="next"><a href="/slamdunk-the-vue3/main/vue/compiler/transform/vOnce.html">
        vOnce
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/slamdunk-the-vue3/assets/js/app.dea22f88.js" defer></script><script src="/slamdunk-the-vue3/assets/js/2.43eface2.js" defer></script><script src="/slamdunk-the-vue3/assets/js/13.64717b64.js" defer></script>
  </body>
</html>
